image: swedishembedded/build:latest

default:
  tags:
    - docker

stages:
 - build

# This job builds applications
build:
    image: swedishembedded/build:latest
    stage: build
    artifacts:
        paths:
            - build/*.deb
            - build/index.pdf
        expire_in: 1 week
        when: always
    rules:
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    script:
        - ruby -v
        - apt update &&
          apt install -qy libgtest-dev
        - mkdir build &&
          cd build &&
          cmake
            -D"CMAKE_CXX_FLAGS=-g -O2 -w -fprofile-arcs -ftest-coverage"
            -D"CMAKE_C_FLAGS=-g -O2 -w -fprofile-arcs -ftest-coverage" .. &&
          make &&
          make test &&
          ctest -T Coverage &&
          ../scripts/coverage
          cpack &&
          cd ..
